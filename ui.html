<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 16px;
      font-size: 14px;
      line-height: 1.4;
      background-color: #444444;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
      color: #ffffff;
    }
    
    .header .author {
      margin: 0;
      font-size: 14px;
      font-weight: 400;
      color: #ffffff;
    }
    
    .info-container {
      background: #666;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #000;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }
    
    .info-text {
      flex: 1;
      color: #ffffff;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
    }
    
    .coffee-text {
      color: #ffffff;
      font-size: 14px;
      font-weight: 400;
      line-height: 20px;
    }
    
    .coffee-text a {
      color: #ffffff;
      text-decoration: underline;
    }
    
    .coffee-text a:hover {
      color: #cccccc;
    }
    
    .check-btn {
      background: #4851b6;
      color: white;
      border: 1px solid #2f39ab;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0;
      line-height: 20px;
    }
    
    .check-btn:hover {
      background: #3d47b2;
    }
    
    .check-btn:disabled {
      background: #b0b0b0;
      cursor: not-allowed;
    }
    
    .results-container {
      display: none;
    }
    
    .results-container.visible {
      display: block;
    }
    
    .issue-category {
      margin-bottom: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      overflow: visible;
    }
    
    .issue-category.has-issues {
      border-color: #000000;
      /* #de6e70 */
    }
    
    .issue-category.no-issues {
      border-color: #000000; 
      /* #64c41a */
    }
    
    .issue-header {
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      overflow: visible;
      border-radius: 6px 6px 0 0;
    }
    
    .issue-title-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .info-icon {
      cursor: default;
      font-size: 14px;
      opacity: 0.7;
      position: relative;
      transition: opacity 0.2s ease;
    }
    
    .info-icon:hover {
      opacity: 1;
    }
    
    .info-icon .tooltip {
      visibility: hidden;
      position: absolute;
      left: 50%;
      bottom: 125%;
      transform: translateX(-50%);
      background: #1a1a1a;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 400;
      white-space: normal;
      width: 240px;
      max-width: 90vw;
      z-index: 9999;
      border: 1px solid #333;
      line-height: 1.4;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }
    
    .info-icon:hover .tooltip {
      visibility: visible;
    }
    
    .info-icon .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1a1a1a;
    }
    
    .info-icon .tooltip.narrow {
      width: 180px;
    }
    
    .issue-header.has-issues {
      background: #333;
      border-bottom: 1px solid #000000;
      /* #de6e70 */
    }
    
    .issue-header.no-issues {
      background: #333;
      /* #64c41a */
      color: #ffffff;
      border-radius: 6px;
    }
    
    .issue-count {
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .issue-count.has-issues {
      background: #f67a7c;
      color: white;
    }
    
    .issue-count.no-issues {
      background: #69ea28;
      color: white;
    }
    
    .issue-items {
      max-height: 150px;
      overflow-y: auto;
      border-radius: 0 0 6px 6px;
    }
    
    .issue-item {
      padding: 12px 12px;
      border-bottom: 1px solid #333;
      font-size: 11px;
      /* color:#333 */
      background-color: #000;
      transition: background-color 0.2s ease;  /* ADDED: Smooth hover transition */
    }
    
    .issue-item:last-child {
      border-bottom: none;
    }
    
    /* ADDED: Hover effect for clickable items */
    .issue-item.clickable {
      cursor: pointer;
    }
    
    .issue-item.clickable:hover {
      background-color: #1a1a1a;
    }
    
    .issue-name {
      font-weight: 400;
      color: #fff;
      margin-bottom: 4px;
      padding: 8px 0;
    }
    
    .issue-details {
      color: #666;
      font-size: 10px;
      font-weight: 400;
    }
    
    .summary {
      text-align: center;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: 400;
    }
    
    .summary.clean {
      background: #e8f5e8;
      color: #389e0d;
      border: 2px solid #52c41a;
    }
    
    .summary.issues {
      background: #333;
      color: #f67a7c;
      border: 1px solid #000;
    }
    
    .error {
      background: #ffe8e8;
      color: #8b0000;
      padding: 12px;
      border-radius: 2px;
      margin: 16px 0;
      font-size: 12px;
    }
    
    /* .close-btn {
      background: #666;
      color: white;
      border: none;
      padding: 12px 12px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      margin-top: 10px;
    } */
    
    /* .close-btn:hover {
      background: #555;
    } */
  </style>
</head>
<body>
  <div class="header">
    <h2>üîç Layout quality assistant</h2>
    <p class="author">By Dave Chan</p>
  </div>
  
  <div class="info-container">
    <div class="info-row">
      <div class="info-text">Select a frame to begin linting your Figma.</div>
      <button id="analyzeBtn" class="check-btn" disabled>Check</button>
    </div>
    <div class="coffee-text">üôè Please consider buying me a <a href="https://buymeacoffee.com/davechan" target="_blank">cup of coffee</a> ‚òï</div>
  </div>
  
  <div id="resultsContainer" class="results-container">
    <div id="summary" class="summary">
      <!-- Summary will be inserted here -->
    </div>
    
    <div id="issuesList">
      <!-- Issues will be inserted here -->
    </div>
  </div>
  
  <div id="errorContainer"></div>
  
  <!-- <button id="closeBtn" class="close-btn">Close Plugin</button> -->
  
  <script>
    const analyzeBtn = document.getElementById('analyzeBtn');
    // const closeBtn = document.getElementById('closeBtn');
    const resultsContainer = document.getElementById('resultsContainer');
    const summary = document.getElementById('summary');
    const issuesList = document.getElementById('issuesList');
    const errorContainer = document.getElementById('errorContainer');
    
    const ISSUE_EXPLANATIONS = {
      unlabeledLayers: "üí° Proper naming helps developers understand component structure and improves maintainability.",
      hiddenLayers: "üí° Hidden layers can cause confusion during handoff and may indicate leftover elements.",
      fractionalValues: "üí° Use 0, 2px, 4px, or 8px increments for spacing between frames and padding to maintain consistent visual rhythm.",
      groupsUsed: "üí° Groups scale content like images; frames provide better responsive layout control.",
      excessiveAbsolutePositioning: "üí° Too many absolutely positioned elements make layouts fragile and hard to maintain responsively.",
      negativeSpacing: "üí° Negative spacing in auto-layout can cause unexpected overlapping and layout issues."
    };
    
    const ISSUE_TITLES = {
      unlabeledLayers: 'Unlabeled layers',
      hiddenLayers: 'Hidden layers', 
      fractionalValues: 'Inconsistent spacing values',
      groupsUsed: 'Groups instead of frames',
      negativeSpacing: 'Negative auto-layout spacing'
    };
    
    analyzeBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'analyze-selection' } }, '*');
    };
    
    // closeBtn.onclick = () => {
    //   parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    // };
    
    function updateSelectionInfo(name, type, hasSelection) {
      if (hasSelection && type === 'FRAME') {
        analyzeBtn.disabled = false;
      } else {
        analyzeBtn.disabled = true;
      }
    }
    
    function displayResults(frameName, issues) {
      resultsContainer.classList.add('visible');
      
      // Count total issues
      const totalIssues = Object.values(issues).reduce((sum, issueList) => sum + issueList.length, 0);
      
      // Update summary
      if (totalIssues === 0) {
        summary.className = 'summary clean';
        summary.textContent = `üéâ "${frameName}" looks great! No issues found.`;
      } else {
        summary.className = 'summary issues';
        summary.textContent = `üîé Found ${totalIssues} issue${totalIssues === 1 ? '' : 's'} in "${frameName}"`;
      }
      
      // Display issues by category
      issuesList.innerHTML = '';
      Object.keys(issues).forEach(category => {
        const categoryEl = createIssueCategory(category, issues[category]);
        issuesList.appendChild(categoryEl);
      });
    }
    
    function createIssueCategory(category, items) {
      const categoryEl = document.createElement('div');
      const hasIssues = items.length > 0;
      categoryEl.className = `issue-category ${hasIssues ? 'has-issues' : 'no-issues'}`;
      
      // Header
      const headerEl = document.createElement('div');
      headerEl.className = `issue-header ${hasIssues ? 'has-issues' : 'no-issues'}`;
      
      // Title container with info icon
      const titleContainerEl = document.createElement('div');
      titleContainerEl.className = 'issue-title-container';
      
      const titleEl = document.createElement('span');
      titleEl.textContent = ISSUE_TITLES[category] || category;
      
      // Add info icon with tooltip
      const infoIconEl = document.createElement('span');
      infoIconEl.className = 'info-icon';
      infoIconEl.textContent = '‚ÑπÔ∏è';
      
      const tooltipEl = document.createElement('span');
      tooltipEl.className = category === 'hiddenLayers' ? 'tooltip narrow' : 'tooltip';
      tooltipEl.textContent = ISSUE_EXPLANATIONS[category] || '';
      
      infoIconEl.appendChild(tooltipEl);
      titleContainerEl.appendChild(titleEl);
      titleContainerEl.appendChild(infoIconEl);
      
      const countEl = document.createElement('div');
      countEl.className = `issue-count ${hasIssues ? 'has-issues' : 'no-issues'}`;
      countEl.textContent = hasIssues ? items.length : '‚úì';
      
      headerEl.appendChild(titleContainerEl);
      headerEl.appendChild(countEl);
      categoryEl.appendChild(headerEl);
      
      // Items (only show if there are issues)
      if (hasIssues) {
        const itemsEl = document.createElement('div');
        itemsEl.className = 'issue-items';
        
        items.forEach(item => {
          const itemEl = createIssueItem(category, item);
          itemsEl.appendChild(itemEl);
        });
        
        categoryEl.appendChild(itemsEl);
      }
      
      return categoryEl;
    }
    
    // UPDATED: createIssueItem function with click-to-select functionality
    function createIssueItem(category, item) {
      const itemEl = document.createElement('div');
      itemEl.className = 'issue-item';
      
      // Make the item clickable if it has a node ID
      if (item.id) {
        itemEl.classList.add('clickable');
        itemEl.onclick = () => {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'select-node', 
              nodeId: item.id 
            } 
          }, '*');
        };
      }
      
      const nameEl = document.createElement('div');
      nameEl.className = 'issue-name';
      nameEl.textContent = item.name || 'Unnamed';
      
      const detailsEl = document.createElement('div');
      detailsEl.className = 'issue-details';
      
      // Add specific details based on issue type
      let details = '';
      if (item.values) {
        details = item.values.join(', ');
      } else if (item.childCount !== undefined) {
        details = `${item.childCount} children`;
      } else if (item.spacing !== undefined) {
        details = `Spacing: ${item.spacing}px`;
      } else if (item.count !== undefined && item.elements) {
        details = `${item.count} absolute: ${item.elements.join(', ')}`;
      }
      
      if (details) {
        detailsEl.textContent = details;
      }
      
      itemEl.appendChild(nameEl);
      if (details) itemEl.appendChild(detailsEl);
      
      return itemEl;
    }
    
    function showError(message) {
      const errorEl = document.createElement('div');
      errorEl.className = 'error';
      errorEl.textContent = message;
      errorContainer.innerHTML = '';
      errorContainer.appendChild(errorEl);
      
      setTimeout(() => {
        errorContainer.innerHTML = '';
      }, 5000);
    }
    
    window.onmessage = (event) => {
      const message = event.data.pluginMessage;
      
      switch (message.type) {
        case 'selection-change':
          updateSelectionInfo(
            message.selectionName, 
            message.selectionType, 
            message.hasSelection
          );
          
          // Keep results visible so users can continue clicking on issues
          // resultsContainer.classList.remove('visible');
          break;
          
        case 'analysis-complete':
          displayResults(message.frameName, message.issues);
          break;
          
        case 'error':
          showError(message.message);
          break;
      }
    };
  </script>
</body>
</html>